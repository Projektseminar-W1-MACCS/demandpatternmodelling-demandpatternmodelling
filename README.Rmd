---
title: "Cost System Design Model Documentation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introduction

This readme file provides an overview of the underlying Cost System Design Model written in R. The model is mostly based on the numerical framework on Cost System Design proposed by  Anand, V., R. Balakrishnan, and E. Labro (2019). The code and documentation for Anand's et al. model can be found under http://vicanand.weebly.com/abl_jmar_code.html. Goal with this model was to replicate Anand's model and produce the same results using the same overall logic.
However, further heuristics, as well as  adaptions to the Programming Language R distinguish this models Sytnax from its predecessor's. It also contains further improvements and developments. 

The overall objective of this replication model is  first to create a fictional firm (including it's production environment), measrue the production costs of each product (Benachmark Product Costs), secondly build a costing system to calculate again the product costs using different heuristics to e.g. allocate resource costs to pools or choose a cost-driver (Estimated Product Costs) and eventually compare these two measures to compute the error.

## 2. Overview 

This documentation is split into two parts. The first parts gives an overview of the model's structure and influencing parameters (Input and Output). The second part provides a more detailed description of the code. 

## 2.1 Working with the model in RStudio

RStudio is an open source and free to use software which provides an integrated development environment (IDE) for the Programming Language R.

Rstudio can be downloaded here : https://rstudio.com/products/rstudio/download/#download

The Programming Language R itself must be downloaded and installed separatly: https://cran.rstudio.com/

Furthermore the model works with the following library packages which provide functions for e.g. plotting or analysing data. These libraries are installes by running the follwing code in the 0_preparing_project.R file. This needs to be done before running the model itself. 


```{r library packages, include= TRUE, eval = FALSE}
install.packages(c(
  "dplyr",
  "tidyr",
  "rmarkdown",
  "ggplot2"

))

Packages <- c("dplyr", "ggplot2", "rmarkdown", "tidyr")
lapply(Packages, library, character.only = TRUE)
```


## 2.2 Model Overview

The model contains of 9 R-Script files which can be seen in the following model overview. The 0_preparing_project.R file is the starting point for running the model. There, all other files are sourced and so their functions called.

![Cost System Design Model Overview](C:\Users\cms9023\Documents\CostSystemDesignSim\Modeloverview.png)

## 2.3 Model Initialization

The 1_INIT.R file loads all input parameters which are set by the modeller. These will later define the circumstances and limitations for the modelled Production Environment and Costing System. 
First step is to create an empty firm with its subsets Production Environment and Costing System. The FIRM variable is basically just a list that contains all necessary information that are need throughout the varius functions.  
The DATA variable is an empty dataframe which gets filled with the measures that go into the output file.

```{r Input Parameters}
  ## ======================================INPUT MASK============================================================
  FIRM = list()                           
  FIRM$PRODUCTION_ENVIRONMENT = list()
  FIRM$COSTING_SYSTEM = list()
  DATA = data.frame()
  
  
  NUMB_PRO =         50                     #INPUT independent Variable - Number of products 
  NUMB_RES  =        50                     #INPUT independent variable - Number of factors

  SIM_NUMB =         200                    #Control Variable - Number of Simulations for every single environment (standard: 30)     

  TC =               1000000                #Total costs

  ProductOutput=     1                      #Zero = no tracking
  set_pe_constant=   1                      #Control Variable -  Decide if Simulation is reproducible {1} or random {0}
  set_cs_constant=   0                      #Control Variable 
  vary_demand =      0                      #Control Variable
  
  dec_ERROR=         1                      #Control Variable - 
  seed=              13                     #Control Variable -
  
  #dec_DC=           0                      # = no direct costs 
  dec_CP=            1                      # =
  dec_CD=            1                      # =
  
  
  CP = c(1,2,4,6,8,10,12,14,16,18,20)       #No. of Cost Pools
  COR = c(0.6)                              #Correlation between resources
  RC_VAR =  c(-1)                           #Resource cost variation --> base for DISP2
  Q_VAR = c(1)                              #Demand variation
  Error = c(0)                              #Measurement error
  NUMB_Error = c(1)                         #Number of errornoues links
  DENS = c(-1)                              #Number of links between products and resources (sharing)
  CC = 0.4                                  #Correlation Cutoff for correlative assignement in CP HEURISTICS
  MISCPOOLSIZE = 0.25                       #share of total costs that are supposed to go into the miscpool if there is a miscpool in the Costing System
  DISP1 = 10                                #No. of the biggest resources that have a DISP2 share of the total costs
  
## ======================================END OF INPUT MASK===================================================== 
```


The simulation is then run for every combination of the input parameters and the number of simulation that is set with SIM_NUMB. To do this the model loops over every input variable and creates a number of firms (SIM_NUMBs) for every combination of those. 
```{r for loops for code running, eval = FALSE}
            set.seed(seed) #Reproducability
            o=1 # First design point
            
## ====================================== DESIGN OF EXPERIMENTS ================================================== 
## EVIRONMENTAL FACTORS [] 
  for (ix_CP in seq_along(CP)) {
     for (ix_COR in seq_along(COR)) {
       for (ix_RC_VAR in seq_along(RC_VAR)) {
         for (ix_Q_VAR in seq_along(Q_VAR)) {
           for (ix_Error in seq_along(Error)) {
               for (ix_NUMB_Error in seq_along(NUMB_Error)) {
                 for (ix_DENS in seq_along(DENS)) {
                   for(ix_CC in seq_along(CC)){
                     for(ix_MISCPOOLSIZE in seq_along(MISCPOOLSIZE)){
                       for(ix_DISP1 in seq_along(DISP1)){
```


For every created firm the variable is mapped into the FIRM list. By calling this list in every other R-Script file of the model the code gets access to all there contained variables. This ensures that always the same values are used and provides an easy possibility to map created variables back into the FIRM.

```{r Mapping created variables to the FIRM}
 ## ====================== PREDETERMINING AND PREALLOCATION  =========================          
    
    FIRM$PRODUCTION_ENVIRONMENT$DENS = DENS[ix_DENS]   
    FIRM$PRODUCTION_ENVIRONMENT$COR  = COR[ix_COR]
    FIRM$PRODUCTION_ENVIRONMENT$Q_VAR= Q_VAR[ix_Q_VAR]
    FIRM$PRODUCTION_ENVIRONMENT$NUMB_PRO = NUMB_PRO
    FIRM$PRODUCTION_ENVIRONMENT$NUMB_RES = NUMB_RES
    FIRM$COSTING_SYSTEM$CP = CP[ix_CP]
    FIRM$COSTING_SYSTEM$RC_VAR = RC_VAR[ix_RC_VAR]
    FIRM$COSTING_SYSTEM$Error = Error[ix_Error]
    FIRM$COSTING_SYSTEM$NUMB_Error = NUMB_Error[ix_NUMB_Error]
    FIRM$COSTING_SYSTEM$TC = TC
    FIRM$COSTING_SYSTEM$CC = CC
    FIRM$COSTING_SYSTEM$MISCPOOLSIZE = MISCPOOLSIZE
    FIRM$COSTING_SYSTEM$DISP1 = DISP1
```

The simulation is now run for the defined number of SIM_NUMB. As shown in the model overview the model splits into two parts. 

```{r Running the simulation, eval = FALSE}

   nn=1 # necessary for repeating the SIM_NUMB loop
  #### ============================== SIMULATION ======================================
  for (nn in 1:SIM_NUMB) {
    
    #print(FIRM$COSTING_SYSTEM$CP)  
    #print(FIRM$COSTING_SYSTEM$Error)  
    
    
    FIRM = gen_ProductionEnvironment(FIRM) #Generate Production Environment with RES_CONS_PAT

  
    FIRM = MAP_RES_CP_SIZE_CORREL_CUTOFF_MISC_ANAND2(FIRM) #Building the cost pools
  
  
    FIRM = MAP_CP_P_BIGPOOL(FIRM,Error) #Selecting the drivers of a cost pool
    
    
    
    
    ## Calculating the estimated product costs
    FIRM$COSTING_SYSTEM$PCH =  apply((FIRM$COSTING_SYSTEM$ACP) * t(FIRM$COSTING_SYSTEM$ACT_CONS_PAT),2,sum) # CHECKED 2019/09/12
  
      ## ERROR MEASURES AFTER LABRO & VANHOUCKE 2007 
    EUCD = round(sqrt(sum((FIRM$COSTING_SYSTEM$PCB-FIRM$COSTING_SYSTEM$PCH)^2)),digits=2)
    MAPE = round(mean(abs(FIRM$COSTING_SYSTEM$PCB-FIRM$COSTING_SYSTEM$PCH)/FIRM$COSTING_SYSTEM$PCB),digits=4)
    MSE = round(mean(((FIRM$COSTING_SYSTEM$PCB-FIRM$COSTING_SYSTEM$PCH)^2)),digits=2);
  
    
    
  #### ======== COLLECTING THE DATA FOR OUTPUT ==== ####
    preData = data.frame(o,nn,FIRM$COSTING_SYSTEM$CP,FIRM$COSTING_SYSTEM$RC_VAR, FIRM$COSTING_SYSTEM$NUMB_Error, FIRM$COSTING_SYSTEM$Error,
                         FIRM$PRODUCTION_ENVIRONMENT$DENS, FIRM$PRODUCTION_ENVIRONMENT$COR, FIRM$PRODUCTION_ENVIRONMENT$Q_VAR, FIRM$PRODUCTION_ENVIRONMENT$NUMB_PRO,
                         FIRM$PRODUCTION_ENVIRONMENT$NUMB_RES,EUCD,MAPE,MSE)
  
    #preData_p = .datalogging()
    colnames(preData) = c('o','nn','CP','RCC_VAR', 'NUMB_ME', 'NUMB_ME_AD','DENS', 'COR', 'Q_VAR', 
                       'NUMB_PRO', 'NUMB_RES' ,'EUCD','MAPE','MSE')  
    
    #stacking the data with each run
    DATA = rbind(DATA,preData)
    #DATA = rbind(preData,preData)
    
    #Print outputs;
    print(o)
    print(FIRM$COSTING_SYSTEM$CP)
    print((MAPE))
    
    o=o+1 #Counting for the total number of runs
  }
                  }
                }
              }  
            }  
          }
        }
      }
    }
  }
}

```

